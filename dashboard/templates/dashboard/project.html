{% extends "base.html" %}
{% load static %}
{% load dashboard_tags %}


{% block page_header %}
<div class="container header-container">
  <div class="row">
    <div class="col"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row align-items-center" id="sub-heading">
    <div class="d-inline-flex mx-auto">
      <h2 class="px-5 py-3 rounded">{{ project.project_name }}</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-6 mx-auto content-box px-0" id="user-profile">
      <h2 class="text-center mt-3">Dashboard</h2>
      <hr>
      <div class="vert-line"></div>
      <br>
      <div class="row mb-3">
        <div class="col-8">
          <h5 class="float-right mr-4">Original Estimate</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ original_estimate|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row my-3 C-accepted">
        <div class="col-8">
          <h5 class="float-right mr-4">Accepted Changes</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ accepted_changes|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row my-3 T-sub">
        <div class="col-8">
          <h5 class="float-right mr-4">Sub-total</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ subtotal|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row my-3 C-pending">
        <div class="col-8">
          <h5 class="float-right mr-4">Pending Changes</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ pending_changes|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row my-3 C-wip">
        <div class="col-8">
          <h5 class="float-right mr-4">Work in Progress</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ wip_changes|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row my-3 T-total">
        <div class="col-8">
          <h5 class="float-right mr-4">TOTAL</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ total|floatformat:"0" }}</h4>
        </div>
      </div>
      <div class="row mt-5 C-rejected">
        <div class="col-8">
          <h5 class="float-right mr-4">Rejected Changes</h5>
        </div>
        <div class="col-4">
          <h5 class="float-right mr-4">£ {{ rejected_changes|floatformat:"0" }}</h4>
        </div>
      </div>
    </div>
    <div class="col-6 mx-auto content-box px-0" id="list-of-changes">
      <h2 class="text-center mt-3">List of Changes</h2>
      <hr>
      <div class="margin-up mx-2">
        <table id="table-changes" class="compact hover">
          <thead class="">
            <tr>
              <th>Change</th>
              <th>Value</th>
              <th>Status</th>
              <th class="d-none">Link</th>
            </tr>
          </thead>
          <tbody>
            {% for change in changes %}
            <tr>
              <td>{{ change.change_name }}</td>
              <td class="text-right">{{ change.change_cost }}</td>
              <td class="text-center">{{ change.change_status }}</td>
              <td class="d-none change_id_select">{{ change.id }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="btn-top-right">
        <button type="button" class="btn-sm btn-icon-small" data-toggle="modal" data-target="#changeModal">
          <span class="material-icons-outlined ">add</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal to Add Change -->
<div class="modal fade" id="changeModal" tabindex="-1" aria-labelledby="changeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content content-box">
      <div class="modal-header">
        <h2 class="modal-title mt-3" id="changeModalLabel">New Change</h2>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="{% url 'add_change' project.id %}" method="POST">
          {% load crispy_forms_tags %}
          {% crispy form %}
          <input class="btn btn-rect btn-bttm-center" type="submit" value="Submit">
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal to Edit Change -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content content-box">
      <div class="modal-header">
        <h2 class="modal-title mt-3" id="editModalLabel">Change</h2>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editForm" action="" method="POST">
          {% load crispy_forms_tags %}
          {% crispy editForm %}
          <input class="btn btn-rect btn-bttm-center" type="submit" value="Submit">
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script>
  $('tr').click(function () {
    var change_id = $(this).children('.change_id_select').text()
    
    $.ajax({
        url: `/dashboard/edit_change/${change_id}/`,
        dataType: 'json',
        success: function (data) {
          var post_url = `/dashboard/edit_change/${data.id}/`;
          $('#editForm').find('input#id_change_name').attr("value", data.change_name);
          $('#editForm').find('select#id_change_status option').each(function() {
            if ($(this).val() == data.change_status) {
              $(this).attr("selected", "selected");
            }
          });
          $('#editForm').find('input#id_change_cost').attr("value", data.change_cost);
          $('#editForm').attr('action', post_url)
          $('#editModal').modal('show');
        }
      });
      
    });
</script>
{% endblock %}